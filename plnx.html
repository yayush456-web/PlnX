<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#000000" id="theme-meta">
<meta name="mobile-web-app-capable" content="true">
<meta name="apple-mobile-web-app-capable" content="true">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PlnX">
<title>PlnX</title>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Figtree:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ════════════════════════════════════════════
   PlnX · Apple × University Design System
   Pure Black · Breathing Orb · Futuristic
════════════════════════════════════════════ */

:root {
  /* Subject colors */
  --med: #0a84ff; --med-dim: rgba(10,132,255,.15);
  --surg: #ff9f0a; --surg-dim: rgba(255,159,10,.15);
  --paed: #30d158; --paed-dim: rgba(48,209,88,.15);
  --og: #ff375f; --og-dim: rgba(255,55,95,.15);
  --fm: #bf5af2; --fm-dim: rgba(191,90,242,.15);
  --cm: #5ac8fa; --cm-dim: rgba(90,200,250,.15);

  /* System */
  --accent: #0a84ff;
  --accent2: #007aff;
  --green: #30d158;
  --amber: #ff9f0a;
  --red: #ff453a;
  --purple: #bf5af2;
  --teal: #5ac8fa;

  --radius: 18px;
  --radius-sm: 12px;
  --spring: cubic-bezier(.32,.72,0,1);
  --ease: cubic-bezier(.4,0,.2,1);
}

[data-theme="dark"] {
  --bg: #000000; --bg2: #0c0c0e;
  --card: #1c1c1e; --card2: #2c2c2e; --card3: #3a3a3c;
  --border: rgba(255,255,255,.08); --border2: rgba(255,255,255,.12);
  --text: #ffffff; --text2: rgba(235,235,245,.72); --text3: rgba(235,235,245,.45); --text4: rgba(235,235,245,.20);
  --fill: rgba(255,255,255,.06); --fill2: rgba(255,255,255,.10); --fill3: rgba(255,255,255,.04);
  --shadow: rgba(0,0,0,.7);
  --nav-bg: rgba(18,18,20,.94);
  --header-bg: rgba(0,0,0,.88);
}

[data-theme="light"] {
  --bg: #f2f2f7; --bg2: #e5e5ea;
  --card: #ffffff; --card2: #f2f2f7; --card3: #e5e5ea;
  --border: rgba(0,0,0,.08); --border2: rgba(0,0,0,.12);
  --text: #000000; --text2: rgba(60,60,67,.70); --text3: rgba(60,60,67,.45); --text4: rgba(60,60,67,.20);
  --fill: rgba(0,0,0,.04); --fill2: rgba(0,0,0,.07); --fill3: rgba(0,0,0,.02);
  --shadow: rgba(0,0,0,.10);
  --nav-bg: rgba(249,249,249,.94);
  --header-bg: rgba(242,242,247,.92);
}

*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body {
  width: 100%; max-width: 430px; margin: 0 auto;
  height: 100%; overflow: hidden;
  background: var(--bg);
  font-family: -apple-system, 'Figtree', 'SF Pro Text', 'Helvetica Neue', sans-serif;
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  letter-spacing: -.02em;
}

#app { display: flex; flex-direction: column; height: 100dvh; overflow: hidden; position: relative; }

/* ── PAGES ── */
.page {
  display: none; flex-direction: column; flex: 1;
  overflow-y: auto; overflow-x: hidden;
  padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
  scrollbar-width: none;
}
.page::-webkit-scrollbar { display: none; }
.page.active { display: flex; }

/* ── NAV BAR ── */
nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 430px;
  height: calc(58px + env(safe-area-inset-bottom, 0px));
  padding-bottom: env(safe-area-inset-bottom, 0px);
  background: var(--nav-bg);
  backdrop-filter: saturate(180%) blur(40px);
  -webkit-backdrop-filter: saturate(180%) blur(40px);
  border-top: .5px solid var(--border2);
  display: flex; align-items: center; z-index: 200;
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 3px; height: 58px;
  background: none; border: none; cursor: pointer;
  color: var(--text3); transition: color .18s; padding: 6px 0 2px;
}
.nav-btn.active { color: var(--accent); }
.nav-btn svg { width: 24px; height: 24px; stroke-width: 1.6; transition: transform .2s var(--spring); }
.nav-btn.active svg { transform: scale(1.1); }
.nav-btn span { font-size: 9px; font-weight: 600; letter-spacing: .2px; text-transform: uppercase; }

/* ── PAGE HEADER ── */
.page-header {
  padding: calc(16px + env(safe-area-inset-top, 0px)) 20px 14px;
  display: flex; align-items: flex-end; justify-content: space-between; flex-shrink: 0;
  background: var(--header-bg);
  backdrop-filter: saturate(180%) blur(24px);
  -webkit-backdrop-filter: saturate(180%) blur(24px);
  position: sticky; top: 0; z-index: 10;
  border-bottom: .5px solid var(--border);
}
.page-title { font-size: 32px; font-weight: 800; letter-spacing: -.8px; color: var(--text); line-height: 1; }
.page-title-sub { font-size: 13px; font-weight: 500; color: var(--text3); margin-top: 2px; }
.header-btn {
  background: var(--fill2); border: none; border-radius: 50%; width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text2);
  transition: background .15s, transform .12s;
}
.header-btn:active { transform: scale(.93); }
.header-btn svg { width: 16px; height: 16px; }

/* ── SECTION LABEL ── */
.sec-lbl {
  font-size: 11px; font-weight: 700; letter-spacing: .6px; text-transform: uppercase;
  color: var(--text3); padding: 20px 20px 8px;
}

/* ── CARD ── */
.card { background: var(--card); border-radius: var(--radius); overflow: hidden; }
.card-mx { margin: 0 16px; }
.card-mb { margin-bottom: 8px; }
.card-pad { padding: 16px; }

/* ── DIVIDER ── */
.divider { height: .5px; background: var(--border); margin: 0 16px; }

/* ── INPUT ── */
.inp {
  width: 100%; background: var(--fill); border: none; border-radius: var(--radius-sm);
  padding: 13px 16px; color: var(--text); font-size: 16px; outline: none;
  font-family: inherit; -webkit-appearance: none; appearance: none; transition: background .15s;
}
.inp:focus { background: var(--fill2); outline: 2px solid var(--accent); outline-offset: 0; }
.inp::placeholder { color: var(--text4); }
select.inp { cursor: pointer; }

/* ── BUTTON ── */
.btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  border: none; border-radius: 14px; cursor: pointer; font-family: inherit;
  font-weight: 700; transition: opacity .15s, transform .12s; letter-spacing: -.2px;
}
.btn:active { opacity: .75; transform: scale(.97); }
.btn-primary { background: var(--accent); color: #fff; padding: 14px 20px; font-size: 16px; width: 100%; }
.btn-ghost { background: var(--fill); color: var(--text); padding: 11px 16px; font-size: 14px; }
.btn-danger { background: rgba(255,69,58,.15); color: var(--red); padding: 11px 16px; font-size: 14px; }
.btn-sm { padding: 8px 14px; font-size: 13px; border-radius: 10px; }

/* ── PILL ── */
.pill {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: .1px;
}

/* ── TOAST ── */
.toast {
  position: fixed; bottom: calc(88px + env(safe-area-inset-bottom,0px)); left: 50%;
  transform: translateX(-50%) translateY(20px); z-index: 9000;
  background: var(--card2); color: var(--text); font-size: 14px; font-weight: 600;
  padding: 12px 20px; border-radius: 20px; opacity: 0; pointer-events: none;
  box-shadow: 0 8px 40px var(--shadow); white-space: nowrap;
  transition: opacity .25s, transform .25s var(--spring);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  border: .5px solid var(--border2);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ── MODAL SHEET ── */
.sheet-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 800;
  opacity: 0; pointer-events: none; transition: opacity .25s;
  backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
}
.sheet-overlay.show { opacity: 1; pointer-events: all; }
.sheet {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
  width: 100%; max-width: 430px; z-index: 900;
  background: var(--bg2); border-radius: 24px 24px 0 0;
  padding: 0 0 calc(24px + env(safe-area-inset-bottom,0px));
  transition: transform .35s var(--spring);
  max-height: 92dvh; overflow-y: auto; overflow-x: hidden;
  scrollbar-width: none;
}
.sheet::-webkit-scrollbar { display: none; }
.sheet.show { transform: translateX(-50%) translateY(0); }
.sheet-handle {
  width: 36px; height: 4px; background: var(--border2); border-radius: 2px;
  margin: 12px auto 20px;
}
.sheet-title { font-size: 18px; font-weight: 800; padding: 0 20px 16px; letter-spacing: -.4px; }

/* ══════════════════════════════════════════════
   PAGE 1 — TODAY (Day Planner)
══════════════════════════════════════════════ */
.planner-date-strip {
  display: flex; gap: 6px; overflow-x: auto; padding: 12px 16px;
  scrollbar-width: none; flex-shrink: 0;
}
.planner-date-strip::-webkit-scrollbar { display: none; }
.date-chip {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  padding: 8px 10px; border-radius: 14px; min-width: 44px; cursor: pointer;
  background: var(--fill); transition: background .15s, color .15s;
  border: 1px solid transparent;
}
.date-chip.today { background: var(--accent); color: #fff; border-color: transparent; }
.date-chip.selected:not(.today) { border-color: var(--accent); background: rgba(10,132,255,.1); }
.date-chip .day-name { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .3px; color: var(--text3); }
.date-chip.today .day-name, .date-chip.selected .day-name { color: inherit; opacity: .8; }
.date-chip .day-num { font-size: 18px; font-weight: 800; letter-spacing: -.4px; }

.planner-timeline { padding: 0 16px; position: relative; }
.time-block {
  display: flex; gap: 10px; min-height: 60px; position: relative;
}
.time-block:last-child .tb-line { display: none; }
.tb-time {
  width: 44px; flex-shrink: 0; padding-top: 12px;
  font-size: 11px; font-weight: 600; color: var(--text3); text-align: right;
  font-family: 'Space Mono', monospace; letter-spacing: -.5px;
}
.tb-connector { display: flex; flex-direction: column; align-items: center; padding-top: 16px; width: 18px; flex-shrink: 0; }
.tb-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border2); flex-shrink: 0; transition: background .2s; }
.tb-line { width: 1.5px; flex: 1; background: var(--border); margin-top: 4px; }
.tb-content { flex: 1; padding: 8px 0 8px; }

.event-block {
  border-radius: 12px; padding: 10px 12px; margin-bottom: 6px; cursor: pointer;
  transition: transform .15s, opacity .15s; border-left: 3px solid;
  position: relative;
}
.event-block:active { transform: scale(.98); opacity: .85; }
.event-title { font-size: 14px; font-weight: 700; letter-spacing: -.2px; line-height: 1.2; }
.event-meta { font-size: 11px; font-weight: 500; margin-top: 3px; opacity: .7; }
.event-time-badge {
  position: absolute; top: 8px; right: 10px;
  font-size: 10px; font-weight: 700; font-family: 'Space Mono', monospace; opacity: .7;
}

.now-indicator {
  display: flex; align-items: center; gap: 8px; margin: 4px 0;
}
.now-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--red); flex-shrink: 0; box-shadow: 0 0 8px var(--red); }
.now-line { flex: 1; height: 1px; background: var(--red); opacity: .6; }
.now-time { font-size: 10px; font-weight: 700; color: var(--red); font-family: 'Space Mono', monospace; flex-shrink: 0; }

.add-event-btn {
  position: fixed; bottom: calc(78px + env(safe-area-inset-bottom,0px)); right: 16px;
  width: 52px; height: 52px; border-radius: 50%; background: var(--accent);
  border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 24px rgba(10,132,255,.45), 0 2px 8px rgba(0,0,0,.3);
  transition: transform .2s var(--spring), box-shadow .2s; z-index: 50;
}
.add-event-btn:active { transform: scale(.92); }
.add-event-btn svg { width: 22px; height: 22px; color: #fff; stroke-width: 2.5; }

/* Today overview cards */
.today-stats {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px 16px 4px;
}
.stat-card {
  background: var(--card); border-radius: 14px; padding: 14px; cursor: default;
}
.stat-val { font-size: 26px; font-weight: 800; letter-spacing: -.8px; line-height: 1; }
.stat-lbl { font-size: 11px; font-weight: 600; color: var(--text3); margin-top: 4px; letter-spacing: .1px; text-transform: uppercase; }

/* ══════════════════════════════════════════════
   PAGE 2 — TIMETABLE MAKER
══════════════════════════════════════════════ */
.week-header {
  display: grid; grid-template-columns: 48px repeat(6,1fr); gap: 2px;
  padding: 0 12px 4px; flex-shrink: 0;
}
.wh-day { text-align: center; font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: .4px; padding: 4px 0; }
.wh-today { color: var(--accent); }

.timetable-grid {
  padding: 0 12px; overflow-y: auto; flex: 1;
}
.timetable-row { display: grid; grid-template-columns: 48px repeat(6,1fr); gap: 2px; min-height: 48px; }
.tt-time { display: flex; align-items: flex-start; padding-top: 6px; justify-content: flex-end; padding-right: 8px; }
.tt-time span { font-size: 9px; font-weight: 600; color: var(--text4); font-family: 'Space Mono', monospace; }
.tt-cell {
  background: var(--fill3); border-radius: 6px; cursor: pointer; min-height: 48px; padding: 4px;
  transition: background .15s; position: relative; border: 1px solid var(--border);
}
.tt-cell:hover, .tt-cell:active { background: var(--fill2); }
.tt-class-chip {
  width: 100%; height: 100%; min-height: 40px; border-radius: 4px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 4px 2px; text-align: center; cursor: pointer;
}
.tt-class-chip .cc-subject { font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: .3px; }
.tt-class-chip .cc-type { font-size: 7px; font-weight: 500; opacity: .7; margin-top: 1px; }

/* ══════════════════════════════════════════════
   PAGE 3 — ROTATIONS
══════════════════════════════════════════════ */
.rotation-header-card {
  margin: 12px 16px 0; border-radius: 18px; overflow: hidden;
  background: linear-gradient(135deg, var(--card) 0%, var(--card2) 100%);
}

.rotation-card {
  margin: 0 16px; border-radius: 16px; padding: 16px;
  background: var(--card); cursor: pointer;
  transition: transform .15s, opacity .15s; border: 1px solid var(--border);
}
.rotation-card:active { transform: scale(.98); opacity: .85; }
.rotation-card + .rotation-card { margin-top: 8px; }

.rc-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.rc-dept { font-size: 18px; font-weight: 800; letter-spacing: -.4px; }
.rc-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
.rc-dates { font-size: 12px; color: var(--text3); font-weight: 500; margin-bottom: 10px; }
.rc-progress { height: 3px; background: var(--fill2); border-radius: 2px; overflow: hidden; }
.rc-prog-fill { height: 100%; border-radius: 2px; transition: width .6s var(--ease); }
.rc-stats { display: flex; gap: 16px; margin-top: 10px; }
.rc-stat { display: flex; flex-direction: column; gap: 1px; }
.rc-stat-val { font-size: 14px; font-weight: 800; letter-spacing: -.3px; }
.rc-stat-lbl { font-size: 10px; color: var(--text3); font-weight: 600; text-transform: uppercase; letter-spacing: .3px; }

.semester-banner {
  margin: 12px 16px 0; border-radius: 18px; padding: 16px 18px;
  display: flex; align-items: center; justify-content: space-between;
}
.sb-left { flex: 1; }
.sb-title { font-size: 13px; font-weight: 700; color: var(--text2); margin-bottom: 4px; }
.sb-date { font-size: 20px; font-weight: 800; letter-spacing: -.5px; }
.sb-days { font-size: 28px; font-weight: 900; color: var(--accent); font-family: 'Space Mono', monospace; letter-spacing: -1px; }
.sb-days-lbl { font-size: 11px; color: var(--text3); font-weight: 600; text-transform: uppercase; margin-top: 2px; }

/* ══════════════════════════════════════════════
   PAGE 4 — FOCUS (Pomodoro)
══════════════════════════════════════════════ */
#focus-page { background: var(--bg); }

.focus-orb-container {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  flex: 1; padding: 20px; gap: 0;
}

.orb-wrapper {
  position: relative; width: 240px; height: 240px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; flex-shrink: 0;
}

.orb-ring-svg { position: absolute; inset: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
.orb-ring-bg { stroke: var(--fill2); stroke-width: 3; fill: none; }
.orb-ring-fill {
  stroke: var(--accent); stroke-width: 3; fill: none;
  stroke-linecap: round;
  stroke-dasharray: 691; /* 2π × 110 */
  stroke-dashoffset: 0;
  transition: stroke-dashoffset .5s linear, stroke .5s;
}

.orb-glow {
  position: absolute; width: 160px; height: 160px; border-radius: 50%;
  background: radial-gradient(circle, rgba(10,132,255,.25) 0%, rgba(10,132,255,.05) 60%, transparent 100%);
  transition: transform 3s ease-in-out, opacity .5s;
  animation: orbPulse 4s ease-in-out infinite;
}
@keyframes orbPulse {
  0%, 100% { transform: scale(1); opacity: .6; }
  50% { transform: scale(1.12); opacity: 1; }
}
.orb-glow.break { background: radial-gradient(circle, rgba(48,209,88,.25) 0%, rgba(48,209,88,.05) 60%, transparent 100%); animation: orbPulseGreen 4s ease-in-out infinite; }
@keyframes orbPulseGreen {
  0%, 100% { transform: scale(1); opacity: .6; }
  50% { transform: scale(1.1); opacity: .9; }
}
.orb-inner {
  position: relative; width: 140px; height: 140px; border-radius: 50%;
  background: var(--card); display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 0;
  border: .5px solid var(--border2); z-index: 2;
}
.orb-time {
  font-size: 38px; font-weight: 800; font-family: 'Space Mono', monospace;
  letter-spacing: -2px; color: var(--text); line-height: 1;
}
.orb-phase { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-top: 2px; }

.focus-controls { display: flex; gap: 10px; margin-top: 24px; }
.fc-btn {
  flex: 1; height: 52px; border-radius: 16px; border: none; cursor: pointer;
  font-family: inherit; font-size: 14px; font-weight: 700; transition: transform .15s, opacity .15s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.fc-btn:active { transform: scale(.95); opacity: .8; }
.fc-start { background: var(--accent); color: #fff; flex: 2; }
.fc-stop { background: var(--fill2); color: var(--text2); }
.fc-skip { background: var(--fill2); color: var(--text2); }

.focus-config {
  display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
  padding: 0 16px; margin-top: 8px;
}
.fc-config-card {
  background: var(--card); border-radius: 14px; padding: 12px; text-align: center; cursor: pointer;
  transition: background .15s; border: 1px solid var(--border);
}
.fc-config-card.selected { border-color: var(--accent); background: rgba(10,132,255,.08); }
.fcc-val { font-size: 20px; font-weight: 800; letter-spacing: -.5px; font-family: 'Space Mono', monospace; }
.fcc-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .4px; color: var(--text3); margin-top: 3px; }

.focus-streak { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 20px; }
.streak-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--fill2); transition: background .3s; }
.streak-dot.done { background: var(--accent); }
.streak-dot.break-dot { background: var(--green); width: 6px; height: 6px; }

.focus-subject-select {
  padding: 0 16px; margin-top: 4px;
}
.fss-label { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: .4px; margin-bottom: 6px; }
.subject-chips { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; }
.subject-chips::-webkit-scrollbar { display: none; }
.subj-chip {
  padding: 7px 13px; border-radius: 20px; border: none; cursor: pointer; font-family: inherit;
  font-size: 12px; font-weight: 700; white-space: nowrap; background: var(--fill); color: var(--text3);
  transition: all .15s; flex-shrink: 0;
}
.subj-chip.selected { color: #fff; }

.focus-log { padding: 0 16px; margin-top: 4px; }
.fl-row {
  display: flex; align-items: center; gap: 10px; padding: 10px 0;
  border-bottom: .5px solid var(--border);
}
.fl-row:last-child { border-bottom: none; }
.fl-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.fl-subject { font-size: 13px; font-weight: 700; flex: 1; }
.fl-time { font-size: 12px; color: var(--text3); font-family: 'Space Mono', monospace; }
.fl-dur { font-size: 11px; color: var(--text3); }

/* ══════════════════════════════════════════════
   PAGE 5 — SETTINGS
══════════════════════════════════════════════ */
.settings-row {
  display: flex; align-items: center; padding: 14px 16px; cursor: pointer;
  background: var(--card); transition: opacity .15s;
}
.settings-row:active { opacity: .7; }
.sr-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-right: 12px; }
.sr-icon svg { width: 17px; height: 17px; color: #fff; }
.sr-body { flex: 1; min-width: 0; }
.sr-title { font-size: 16px; font-weight: 500; }
.sr-sub { font-size: 12px; color: var(--text3); margin-top: 1px; }
.sr-right { color: var(--text3); display: flex; align-items: center; gap: 6px; font-size: 14px; }
.sr-right svg { width: 14px; height: 14px; }

/* toggle */
.toggle-wrap { position: relative; width: 51px; height: 31px; flex-shrink: 0; }
.toggle-wrap input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-slider {
  position: absolute; inset: 0; border-radius: 15.5px;
  background: var(--card3); cursor: pointer; transition: background .3s;
}
.toggle-slider::before {
  content: ''; position: absolute; width: 27px; height: 27px; border-radius: 50%;
  background: #fff; top: 2px; left: 2px;
  box-shadow: 0 2px 8px rgba(0,0,0,.3); transition: transform .3s var(--spring);
}
input:checked + .toggle-slider { background: var(--green); }
input:checked + .toggle-slider::before { transform: translateX(20px); }

/* ══════════════════════════════════════════════
   SUBJECT COLOR SYSTEM
══════════════════════════════════════════════ */
.s-med { color: var(--med); }
.s-surg { color: var(--surg); }
.s-paed { color: var(--paed); }
.s-og { color: var(--og); }
.s-fm { color: var(--fm); }
.s-cm { color: var(--cm); }

.bg-med { background: var(--med-dim); border-color: var(--med) !important; }
.bg-surg { background: var(--surg-dim); border-color: var(--surg) !important; }
.bg-paed { background: var(--paed-dim); border-color: var(--paed) !important; }
.bg-og { background: var(--og-dim); border-color: var(--og) !important; }
.bg-fm { background: var(--fm-dim); border-color: var(--fm) !important; }
.bg-cm { background: var(--cm-dim); border-color: var(--cm) !important; }

.bc-med { border-left-color: var(--med) !important; }
.bc-surg { border-left-color: var(--surg) !important; }
.bc-paed { border-left-color: var(--paed) !important; }
.bc-og { border-left-color: var(--og) !important; }
.bc-fm { border-left-color: var(--fm) !important; }
.bc-cm { border-left-color: var(--cm) !important; }

.chip-med { background: var(--med); color: #fff !important; }
.chip-surg { background: var(--surg); color: #fff !important; }
.chip-paed { background: var(--paed); color: #fff !important; }
.chip-og { background: var(--og); color: #fff !important; }
.chip-fm { background: var(--fm); color: #fff !important; }
.chip-cm { background: var(--cm); color: #fff !important; }

/* ══════════════════════════════════════════════
   ADD EVENT SHEET EXTRAS
══════════════════════════════════════════════ */
.color-dots { display: flex; gap: 8px; padding: 4px 0; }
.color-dot {
  width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
  border: 2px solid transparent; transition: transform .15s, border-color .15s;
  display: flex; align-items: center; justify-content: center;
}
.color-dot.selected { border-color: var(--text); transform: scale(1.15); }
.color-dot svg { width: 12px; height: 12px; color: #fff; display: none; }
.color-dot.selected svg { display: flex; }

/* ══════════════════════════════════════════════
   EXAM COUNTDOWN
══════════════════════════════════════════════ */
.exam-card {
  margin: 12px 16px 0; padding: 16px 18px; border-radius: 18px;
  background: linear-gradient(135deg, rgba(255,69,58,.15) 0%, rgba(255,159,10,.08) 100%);
  border: 1px solid rgba(255,69,58,.25);
}
.ec-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: var(--red); margin-bottom: 6px; }
.ec-title { font-size: 18px; font-weight: 800; letter-spacing: -.4px; margin-bottom: 8px; }
.ec-countdown { display: flex; gap: 16px; }
.ec-unit { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.ec-num { font-size: 28px; font-weight: 900; font-family: 'Space Mono', monospace; letter-spacing: -1px; line-height: 1; color: var(--text); }
.ec-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .4px; color: var(--text3); }

/* ══════════════════════════════════════════════
   EMPTY STATES
══════════════════════════════════════════════ */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; gap: 10px; }
.empty-state svg { width: 40px; height: 40px; color: var(--text4); }
.empty-state p { font-size: 15px; color: var(--text3); font-weight: 500; text-align: center; }

/* ══════════════════════════════════════════════
   ANIMATIONS
══════════════════════════════════════════════ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.fade-up { animation: fadeUp .3s var(--ease) both; }

@keyframes shimmer { to { background-position: -200% 0; } }

/* ══════════════════════════════════════════════
   FOCUS SESSION ACTIVE STATE
══════════════════════════════════════════════ */
.focus-active .orb-inner { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(10,132,255,.3); }

/* Header PlnX logo */
.plnx-logo {
  font-size: 22px; font-weight: 900; letter-spacing: -1px;
  font-family: 'Figtree', sans-serif;
}
.plnx-logo span { color: var(--accent); }

/* Inline form rows */
.form-row { padding: 8px 20px; }
.form-label { font-size: 12px; font-weight: 600; color: var(--text3); margin-bottom: 6px; display: block; letter-spacing: .1px; }

</style>
</head>
<body>
<div id="app">

<!-- ══ PAGE: TODAY ══ -->
<div class="page active" id="today-page">
  <div class="page-header" id="today-header">
    <div>
      <div class="plnx-logo">Pln<span>X</span></div>
      <div class="page-title-sub" id="today-date-label">Loading…</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="header-btn" onclick="openSheet('add-event-sheet')" aria-label="Add event">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="header-btn" onclick="toggleTheme()">
        <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
      </button>
    </div>
  </div>

  <!-- Date strip -->
  <div class="planner-date-strip" id="date-strip"></div>

  <!-- Quick stats -->
  <div class="today-stats" id="today-stats">
    <div class="stat-card">
      <div class="stat-val" id="stat-events">0</div>
      <div class="stat-lbl">Classes Today</div>
    </div>
    <div class="stat-card">
      <div class="stat-val s-med" id="stat-focus">0h</div>
      <div class="stat-lbl">Focus Today</div>
    </div>
  </div>

  <!-- Exam countdown -->
  <div class="exam-card" id="exam-countdown-card">
    <div class="ec-label">⚠️ Internal Assessment</div>
    <div class="ec-title">Starts 4th June, 2026</div>
    <div class="ec-countdown" id="exam-countdown"></div>
  </div>

  <!-- Timeline -->
  <div class="sec-lbl">Schedule</div>
  <div class="planner-timeline" id="planner-timeline"></div>
  <div style="height:20px"></div>
</div>

<!-- ══ PAGE: TIMETABLE ══ -->
<div class="page" id="timetable-page">
  <div class="page-header">
    <div>
      <div class="page-title">Timetable</div>
      <div class="page-title-sub">Drag & build your week</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="header-btn" onclick="openSheet('add-class-sheet')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="header-btn" onclick="clearWeekPrompt()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
      </button>
    </div>
  </div>

  <div class="week-header" id="week-header"></div>
  <div class="timetable-grid" id="timetable-grid"></div>
</div>

<!-- ══ PAGE: ROTATIONS ══ -->
<div class="page" id="rotations-page">
  <div class="page-header">
    <div>
      <div class="page-title">Rotations</div>
      <div class="page-title-sub">Clinical & posting schedule</div>
    </div>
    <button class="header-btn" onclick="openSheet('add-rotation-sheet')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
  </div>

  <!-- Semester progress -->
  <div class="semester-banner" style="background:linear-gradient(135deg,rgba(10,132,255,.12) 0%,rgba(191,90,242,.08) 100%);border:1px solid rgba(10,132,255,.2)">
    <div class="sb-left">
      <div class="sb-title">VI Semester · 2023 Batch</div>
      <div class="sb-date">Jan 11 – Jun 2, 2026</div>
      <div style="margin-top:8px;height:3px;background:var(--fill2);border-radius:2px;overflow:hidden">
        <div id="sem-progress-bar" style="height:100%;background:var(--accent);border-radius:2px;transition:width .6s var(--ease)"></div>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-top:5px;font-weight:600"><span id="sem-progress-pct">0%</span> complete</div>
    </div>
    <div style="text-align:right;flex-shrink:0;margin-left:16px">
      <div class="sb-days" id="days-remaining">—</div>
      <div class="sb-days-lbl">Days Left</div>
    </div>
  </div>

  <!-- Exam countdown -->
  <div class="exam-card" style="margin-top:10px">
    <div class="ec-label">⚠️ Internal Assessment</div>
    <div class="ec-title">Starts 4th June, 2026</div>
    <div class="ec-countdown" id="exam-countdown-2"></div>
  </div>

  <div class="sec-lbl">Your Group Posting</div>
  <div id="rotation-list" style="padding:0 0 8px"></div>

  <div class="sec-lbl">Research Project</div>
  <div class="card card-mx card-mb" style="padding:14px 16px">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:40px;height:40px;border-radius:12px;background:rgba(191,90,242,.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      </div>
      <div>
        <div style="font-size:15px;font-weight:700">Research Project Work</div>
        <div style="font-size:12px;color:var(--text3);margin-top:2px">1st – 28th March, 2026</div>
      </div>
      <div id="research-pill" class="pill" style="margin-left:auto"></div>
    </div>
  </div>
</div>

<!-- ══ PAGE: FOCUS ══ -->
<div class="page" id="focus-page">
  <div class="page-header">
    <div>
      <div class="page-title">Focus</div>
      <div class="page-title-sub" id="focus-status-lbl">Ready to begin</div>
    </div>
    <button class="header-btn" onclick="openSheet('focus-log-sheet')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    </button>
  </div>

  <!-- Subject selector -->
  <div class="focus-subject-select">
    <div class="fss-label">Studying</div>
    <div class="subject-chips" id="subject-chips"></div>
  </div>

  <!-- Mode selector -->
  <div class="focus-config" id="focus-config">
    <div class="fc-config-card selected" onclick="selectMode(this,25,5)" data-work="25" data-break="5">
      <div class="fcc-val">25</div>
      <div class="fcc-lbl">Focus</div>
    </div>
    <div class="fc-config-card" onclick="selectMode(this,50,10)" data-work="50" data-break="10">
      <div class="fcc-val">50</div>
      <div class="fcc-lbl">Deep</div>
    </div>
    <div class="fc-config-card" onclick="selectMode(this,90,20)" data-work="90" data-break="20">
      <div class="fcc-val">90</div>
      <div class="fcc-lbl">Flow</div>
    </div>
  </div>

  <!-- Orb -->
  <div class="focus-orb-container">
    <div class="orb-wrapper" id="orb-wrapper" onclick="toggleFocus()">
      <svg class="orb-ring-svg" viewBox="0 0 240 240">
        <circle class="orb-ring-bg" cx="120" cy="120" r="110"/>
        <circle class="orb-ring-fill" id="orb-ring" cx="120" cy="120" r="110"/>
      </svg>
      <div class="orb-glow" id="orb-glow"></div>
      <div class="orb-inner">
        <div class="orb-time" id="orb-time">25:00</div>
        <div class="orb-phase" id="orb-phase">Tap to begin</div>
      </div>
    </div>

    <!-- Streak dots -->
    <div class="focus-streak" id="focus-streak"></div>

    <!-- Controls -->
    <div class="focus-controls">
      <button class="fc-btn fc-stop" id="fc-stop" onclick="stopFocus()" style="display:none">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"/></svg>
        Stop
      </button>
      <button class="fc-btn fc-start" id="fc-main" onclick="toggleFocus()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Start Session
      </button>
      <button class="fc-btn fc-skip" id="fc-skip" onclick="skipPhase()" style="display:none">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 4 15 12 5 20"/><line x1="19" y1="4" x2="19" y2="20"/></svg>
        Skip
      </button>
    </div>
  </div>

  <!-- Today's log -->
  <div class="sec-lbl">Today's Sessions</div>
  <div class="focus-log" id="focus-log-preview"></div>
  <div style="height:8px"></div>
</div>

<!-- ══ PAGE: SETTINGS ══ -->
<div class="page" id="settings-page">
  <div class="page-header">
    <div><div class="page-title">Settings</div></div>
  </div>

  <div class="sec-lbl">Appearance</div>
  <div class="card card-mx card-mb">
    <div class="settings-row" onclick="toggleTheme()">
      <div class="sr-icon" style="background:#636366"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg></div>
      <div class="sr-body"><div class="sr-title">Appearance</div><div class="sr-sub" id="theme-label">Dark Mode</div></div>
      <div class="sr-right"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="divider"></div>
    <div class="settings-row">
      <div class="sr-icon" style="background:#30d158"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg></div>
      <div class="sr-body"><div class="sr-title">Sound & Haptics</div><div class="sr-sub">Timer end alert</div></div>
      <label class="toggle-wrap"><input type="checkbox" id="sound-toggle" checked><div class="toggle-slider"></div></label>
    </div>
  </div>

  <div class="sec-lbl">Data</div>
  <div class="card card-mx card-mb">
    <div class="settings-row" onclick="exportData()">
      <div class="sr-icon" style="background:#0a84ff"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
      <div class="sr-body"><div class="sr-title">Export Data</div><div class="sr-sub">Download JSON backup</div></div>
      <div class="sr-right"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="divider"></div>
    <div class="settings-row" onclick="clearAllData()">
      <div class="sr-icon" style="background:#ff453a"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></div>
      <div class="sr-body"><div class="sr-title">Clear All Data</div><div class="sr-sub">Cannot be undone</div></div>
      <div class="sr-right"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
  </div>

  <div class="sec-lbl">About</div>
  <div class="card card-mx card-mb">
    <div class="settings-row" style="cursor:default">
      <div class="sr-icon" style="background:linear-gradient(135deg,#0a84ff,#bf5af2)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <div class="sr-body"><div class="sr-title">PlnX</div><div class="sr-sub">Version 1.0 · BPKIHS VI Sem 2023</div></div>
      <div class="sr-right" style="font-size:12px;font-weight:700;color:var(--accent)">v1.0</div>
    </div>
  </div>
  <div style="height:8px"></div>
</div>

<!-- ══ NAVIGATION ══ -->
<nav>
  <button class="nav-btn active" onclick="switchPage('today',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    <span>Today</span>
  </button>
  <button class="nav-btn" onclick="switchPage('timetable',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
    <span>Week</span>
  </button>
  <button class="nav-btn" onclick="switchPage('rotations',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    <span>Clinic</span>
  </button>
  <button class="nav-btn" onclick="switchPage('focus',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
    <span>Focus</span>
  </button>
  <button class="nav-btn" onclick="switchPage('settings',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    <span>More</span>
  </button>
</nav>

<!-- ══ TOAST ══ -->
<div class="toast" id="toast"></div>

<!-- ══ SHEET OVERLAY ══ -->
<div class="sheet-overlay" id="sheet-overlay" onclick="closeSheets()"></div>

<!-- ══ ADD EVENT SHEET ══ -->
<div class="sheet" id="add-event-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Add Event</div>
  <div class="form-row"><label class="form-label">Title</label><input class="inp" id="ev-title" placeholder="e.g. SIS: Coronary Heart Disease" /></div>
  <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div><label class="form-label">Start</label><input class="inp" type="time" id="ev-start" value="08:00"/></div>
    <div><label class="form-label">End</label><input class="inp" type="time" id="ev-end" value="09:00"/></div>
  </div>
  <div class="form-row"><label class="form-label">Subject</label>
    <select class="inp" id="ev-subject">
      <option value="med">Medicine</option>
      <option value="surg">Surgery</option>
      <option value="paed">Paediatrics</option>
      <option value="og">Obs & Gynae</option>
      <option value="fm">FM / Forensic</option>
      <option value="cm">SPH & CM</option>
      <option value="other">Other</option>
    </select>
  </div>
  <div class="form-row"><label class="form-label">Type</label>
    <select class="inp" id="ev-type">
      <option value="SIS">SIS (Structured Interactive Session)</option>
      <option value="SGD">SGD (Small Group Discussion)</option>
      <option value="CBL">CBL (Case Based Learning)</option>
      <option value="LIF">LIF (Learning in Field)</option>
      <option value="LABEX">LABEX (Lab Exercise)</option>
      <option value="SEMINAR">Seminar</option>
      <option value="PMD">PMD (Post Mortem Demo)</option>
      <option value="SELF">Self Study</option>
      <option value="OTHER">Other</option>
    </select>
  </div>
  <div class="form-row"><label class="form-label">Location (optional)</label><input class="inp" id="ev-location" placeholder="e.g. LT-III, New Academic Block" /></div>
  <div class="form-row">
    <button class="btn btn-primary" onclick="saveEvent()">Add to Today</button>
  </div>
  <div class="form-row">
    <button class="btn btn-ghost" onclick="closeSheets()">Cancel</button>
  </div>
</div>

<!-- ══ ADD CLASS SHEET ══ -->
<div class="sheet" id="add-class-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Add to Timetable</div>
  <div class="form-row"><label class="form-label">Class / Subject</label><input class="inp" id="cls-title" placeholder="e.g. Medicine — SIS" /></div>
  <div class="form-row"><label class="form-label">Day</label>
    <select class="inp" id="cls-day">
      <option value="0">Sunday</option>
      <option value="1">Monday</option>
      <option value="2">Tuesday</option>
      <option value="3">Wednesday</option>
      <option value="4">Thursday</option>
      <option value="5">Friday</option>
    </select>
  </div>
  <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div><label class="form-label">Start</label><input class="inp" type="time" id="cls-start" value="08:00"/></div>
    <div><label class="form-label">End</label><input class="inp" type="time" id="cls-end" value="09:00"/></div>
  </div>
  <div class="form-row"><label class="form-label">Subject Color</label>
    <select class="inp" id="cls-subject">
      <option value="med">Medicine</option>
      <option value="surg">Surgery</option>
      <option value="paed">Paediatrics</option>
      <option value="og">Obs & Gynae</option>
      <option value="fm">FM / Forensic</option>
      <option value="cm">SPH & CM</option>
      <option value="other">Other</option>
    </select>
  </div>
  <div class="form-row">
    <button class="btn btn-primary" onclick="saveClass()">Add to Week</button>
  </div>
  <div class="form-row">
    <button class="btn btn-ghost" onclick="closeSheets()">Cancel</button>
  </div>
</div>

<!-- ══ ADD ROTATION SHEET ══ -->
<div class="sheet" id="add-rotation-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Add Rotation</div>
  <div class="form-row"><label class="form-label">Department</label>
    <select class="inp" id="rot-dept">
      <option value="Medicine">Medicine</option>
      <option value="Surgery">Surgery</option>
      <option value="Paediatrics">Paediatrics</option>
      <option value="Obs & Gynae">Obs & Gynae</option>
      <option value="Community Medicine">Community Medicine</option>
      <option value="Forensic Medicine">Forensic Medicine</option>
    </select>
  </div>
  <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div><label class="form-label">Start Date</label><input class="inp" type="date" id="rot-start"/></div>
    <div><label class="form-label">End Date</label><input class="inp" type="date" id="rot-end"/></div>
  </div>
  <div class="form-row"><label class="form-label">Group / Batch</label><input class="inp" id="rot-group" placeholder="e.g. Group A / Batch I" /></div>
  <div class="form-row"><label class="form-label">Notes</label><input class="inp" id="rot-notes" placeholder="Ward, OPD, posting details…" /></div>
  <div class="form-row">
    <button class="btn btn-primary" onclick="saveRotation()">Save Rotation</button>
  </div>
  <div class="form-row">
    <button class="btn btn-ghost" onclick="closeSheets()">Cancel</button>
  </div>
</div>

<!-- ══ FOCUS LOG SHEET ══ -->
<div class="sheet" id="focus-log-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Focus History</div>
  <div id="focus-log-full" style="padding:0 20px 8px"></div>
</div>

</div><!-- #app -->

<script>
// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
const KEY = 'plnx_v1';
let S = {
  theme: 'dark',
  events: {},        // { 'YYYY-MM-DD': [{id,title,start,end,subject,type,location}] }
  classes: [],       // [{id,title,day,start,end,subject}]
  rotations: [],     // [{id,dept,start,end,group,notes}]
  focusLog: [],      // [{date,subject,duration,phase}]
  focusTotalToday: 0,
  pomodoro: { work: 25, break: 5 }
};

function load() {
  try {
    const d = JSON.parse(localStorage.getItem(KEY));
    if (d) S = { ...S, ...d };
  } catch(e) {}
}
function save() {
  try { localStorage.setItem(KEY, JSON.stringify(S)); } catch(e) {}
}
load();
applyTheme();

// ═══════════════════════════════════════════════════════
// SUBJECTS
// ═══════════════════════════════════════════════════════
const SUBJECTS = {
  med:   { name: 'Medicine',    color: '#0a84ff', cls: 'med' },
  surg:  { name: 'Surgery',     color: '#ff9f0a', cls: 'surg' },
  paed:  { name: 'Paediatrics', color: '#30d158', cls: 'paed' },
  og:    { name: 'OG',          color: '#ff375f', cls: 'og' },
  fm:    { name: 'FM',          color: '#bf5af2', cls: 'fm' },
  cm:    { name: 'SPH & CM',    color: '#5ac8fa', cls: 'cm' },
  other: { name: 'Other',       color: '#8e8e93', cls: 'other' }
};
function subColor(k) { return (SUBJECTS[k]||SUBJECTS.other).color; }
function subName(k)  { return (SUBJECTS[k]||SUBJECTS.other).name; }
function subCls(k)   { return (SUBJECTS[k]||SUBJECTS.other).cls; }

// ═══════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════
let currentPage = 'today';
function switchPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(name + '-page').classList.add('active');
  btn.classList.add('active');
  currentPage = name;
  if (name === 'today') renderToday();
  if (name === 'timetable') renderTimetable();
  if (name === 'rotations') renderRotations();
  if (name === 'focus') renderFocusPage();
}

// ═══════════════════════════════════════════════════════
// THEME
// ═══════════════════════════════════════════════════════
function applyTheme() {
  document.documentElement.setAttribute('data-theme', S.theme);
  document.getElementById('theme-meta').setAttribute('content', S.theme === 'dark' ? '#000000' : '#f2f2f7');
  const lbl = document.getElementById('theme-label');
  if (lbl) lbl.textContent = S.theme === 'dark' ? 'Dark Mode' : 'Light Mode';
}
function toggleTheme() {
  S.theme = S.theme === 'dark' ? 'light' : 'dark';
  applyTheme(); save(); showToast('Switched to ' + (S.theme === 'dark' ? 'Dark' : 'Light') + ' Mode');
}

// ═══════════════════════════════════════════════════════
// SHEETS
// ═══════════════════════════════════════════════════════
function openSheet(id) {
  document.getElementById('sheet-overlay').classList.add('show');
  document.getElementById(id).classList.add('show');
  if (id === 'focus-log-sheet') renderFullFocusLog();
}
function closeSheets() {
  document.getElementById('sheet-overlay').classList.remove('show');
  document.querySelectorAll('.sheet').forEach(s => s.classList.remove('show'));
}

// ═══════════════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════════════
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ═══════════════════════════════════════════════════════
// DATE HELPERS
// ═══════════════════════════════════════════════════════
function todayStr() {
  const d = new Date();
  return d.toISOString().slice(0,10);
}
function formatDate(d) {
  return new Intl.DateTimeFormat('en-US', { weekday:'long', month:'long', day:'numeric' }).format(d);
}
function parseTimeToMin(t) {
  const [h,m] = t.split(':').map(Number); return h*60+m;
}
function minToTime(m) {
  const h = Math.floor(m/60), mm = m%60;
  const ap = h >= 12 ? 'PM' : 'AM';
  return ((h%12)||12) + ':' + String(mm).padStart(2,'0') + ' ' + ap;
}

let selectedDateStr = todayStr();

// ═══════════════════════════════════════════════════════
// TODAY PAGE
// ═══════════════════════════════════════════════════════
function renderToday() {
  renderDateStrip();
  renderDateLabel();
  renderTimeline();
  renderTodayStats();
  renderExamCountdown();
}

function renderDateStrip() {
  const strip = document.getElementById('date-strip');
  const today = new Date();
  const todStr = todayStr();
  strip.innerHTML = '';
  for (let i = -3; i <= 6; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + i);
    const ds = d.toISOString().slice(0,10);
    const dayNames = ['Su','Mo','Tu','We','Th','Fr','Sa'];
    const chip = document.createElement('div');
    chip.className = 'date-chip' + (ds === todStr ? ' today' : '') + (ds === selectedDateStr && ds !== todStr ? ' selected' : '');
    if (ds === todStr && ds === selectedDateStr) chip.classList.add('today', 'selected');
    chip.innerHTML = `<span class="day-name">${dayNames[d.getDay()]}</span><span class="day-num">${d.getDate()}</span>`;
    chip.onclick = () => { selectedDateStr = ds; renderToday(); };
    strip.appendChild(chip);
  }
}

function renderDateLabel() {
  const d = new Date(selectedDateStr + 'T12:00:00');
  document.getElementById('today-date-label').textContent = formatDate(d);
}

function renderTodayStats() {
  const events = S.events[selectedDateStr] || [];
  document.getElementById('stat-events').textContent = events.length;
  // Focus minutes today
  const todayLog = S.focusLog.filter(l => l.date === selectedDateStr);
  const mins = todayLog.reduce((a, l) => a + l.duration, 0);
  document.getElementById('stat-focus').textContent = mins >= 60 ? (mins/60).toFixed(1) + 'h' : mins + 'm';
}

function renderTimeline() {
  const container = document.getElementById('planner-timeline');
  const events = (S.events[selectedDateStr] || []).slice().sort((a,b) => parseTimeToMin(a.start) - parseTimeToMin(b.start));
  container.innerHTML = '';

  const startHour = 7, endHour = 20;
  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const isToday = selectedDateStr === todayStr();

  if (events.length === 0) {
    container.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg><p>No classes. Add one with +</p></div>`;
    return;
  }

  let nowInserted = false;
  events.forEach((ev, i) => {
    const startMin = parseTimeToMin(ev.start);
    if (isToday && !nowInserted && nowMin < startMin) {
      nowInserted = true;
      const ni = document.createElement('div');
      ni.className = 'now-indicator';
      ni.innerHTML = `<div class="now-dot"></div><div class="now-line"></div><div class="now-time">${minToTime(nowMin)}</div>`;
      container.appendChild(ni);
    }

    const block = document.createElement('div');
    block.className = 'time-block fade-up';
    block.style.animationDelay = (i * 0.05) + 's';
    const sc = subCls(ev.subject);
    block.innerHTML = `
      <div class="tb-time">${ev.start}</div>
      <div class="tb-connector"><div class="tb-dot" style="background:${subColor(ev.subject)}"></div><div class="tb-line"></div></div>
      <div class="tb-content">
        <div class="event-block bg-${sc} bc-${sc}" onclick="deleteEventPrompt('${selectedDateStr}','${ev.id}')">
          <div class="event-title">${ev.title}</div>
          <div class="event-meta">${ev.type} · ${ev.location || subName(ev.subject)}</div>
          <div class="event-time-badge">${ev.start}–${ev.end}</div>
        </div>
      </div>`;
    container.appendChild(block);
  });

  if (isToday && !nowInserted) {
    const ni = document.createElement('div');
    ni.className = 'now-indicator';
    ni.innerHTML = `<div class="now-dot"></div><div class="now-line"></div><div class="now-time">${minToTime(nowMin)}</div>`;
    container.appendChild(ni);
  }
}

function deleteEventPrompt(dateStr, id) {
  if (!confirm('Remove this event?')) return;
  S.events[dateStr] = (S.events[dateStr] || []).filter(e => e.id !== id);
  save(); renderToday(); showToast('Event removed');
}

function saveEvent() {
  const title = document.getElementById('ev-title').value.trim();
  if (!title) { showToast('Please enter a title'); return; }
  const ev = {
    id: Date.now().toString(),
    title,
    start: document.getElementById('ev-start').value,
    end: document.getElementById('ev-end').value,
    subject: document.getElementById('ev-subject').value,
    type: document.getElementById('ev-type').value,
    location: document.getElementById('ev-location').value.trim()
  };
  if (!S.events[selectedDateStr]) S.events[selectedDateStr] = [];
  S.events[selectedDateStr].push(ev);
  save(); closeSheets(); renderToday();
  document.getElementById('ev-title').value = '';
  document.getElementById('ev-location').value = '';
  showToast('✓ Event added');
}

function renderExamCountdown() {
  const examDate = new Date('2026-06-04T08:00:00');
  const now = new Date();
  const diff = examDate - now;
  if (diff <= 0) { document.getElementById('exam-countdown-card').style.display = 'none'; return; }
  const days = Math.floor(diff / 86400000);
  const hours = Math.floor((diff % 86400000) / 3600000);
  const mins = Math.floor((diff % 3600000) / 60000);
  const html = `
    <div class="ec-unit"><div class="ec-num">${days}</div><div class="ec-lbl">Days</div></div>
    <div class="ec-unit"><div class="ec-num">${hours}</div><div class="ec-lbl">Hours</div></div>
    <div class="ec-unit"><div class="ec-num">${mins}</div><div class="ec-lbl">Mins</div></div>`;
  document.getElementById('exam-countdown').innerHTML = html;
  const ec2 = document.getElementById('exam-countdown-2');
  if (ec2) ec2.innerHTML = html;
}

// ═══════════════════════════════════════════════════════
// TIMETABLE PAGE
// ═══════════════════════════════════════════════════════
const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri'];
const TIME_SLOTS = [];
for (let h = 7; h <= 18; h++) TIME_SLOTS.push(`${String(h).padStart(2,'0')}:00`);

function renderTimetable() {
  // Week header
  const wh = document.getElementById('week-header');
  const todayDay = new Date().getDay(); // 0=Sun
  wh.innerHTML = '<div></div>' + DAYS_SHORT.map((d,i) => `<div class="wh-day${i===todayDay?' wh-today':''}">${d}</div>`).join('');

  // Grid
  const grid = document.getElementById('timetable-grid');
  grid.innerHTML = '';

  TIME_SLOTS.forEach((time, ti) => {
    const row = document.createElement('div');
    row.className = 'timetable-row';

    const timeCell = document.createElement('div');
    timeCell.className = 'tt-time';
    timeCell.innerHTML = `<span>${time}</span>`;
    row.appendChild(timeCell);

    for (let d = 0; d < 6; d++) {
      const cell = document.createElement('div');
      cell.className = 'tt-cell';
      // Find classes for this slot
      const cls = S.classes.filter(c => {
        const cDay = parseInt(c.day);
        const cStart = parseTimeToMin(c.start);
        const cEnd = parseTimeToMin(c.end);
        const slotMin = parseTimeToMin(time);
        return cDay === d && slotMin >= cStart && slotMin < cEnd;
      });
      if (cls.length > 0) {
        const c = cls[0];
        const sc = subCls(c.subject);
        const startMin = parseTimeToMin(c.start);
        const slotMin = parseTimeToMin(time);
        if (slotMin === startMin) {
          const span = Math.ceil((parseTimeToMin(c.end) - startMin) / 60);
          cell.style.background = `${subColor(c.subject)}22`;
          cell.style.borderColor = subColor(c.subject);
          cell.innerHTML = `<div class="tt-class-chip" onclick="deleteClassPrompt('${c.id}')">
            <div class="cc-subject" style="color:${subColor(c.subject)}">${subName(c.subject)}</div>
            <div class="cc-type">${c.start}–${c.end}</div>
            <div class="cc-type" style="font-size:7px;opacity:.6">${c.title.length > 12 ? c.title.slice(0,12)+'…':c.title}</div>
          </div>`;
        } else {
          cell.style.background = `${subColor(c.subject)}12`;
          cell.style.borderColor = `${subColor(c.subject)}44`;
        }
      } else {
        cell.onclick = () => {
          document.getElementById('cls-day').value = d;
          document.getElementById('cls-start').value = time;
          const endH = String(Math.min(19, parseInt(time)+1)).padStart(2,'0');
          document.getElementById('cls-end').value = endH + ':00';
          openSheet('add-class-sheet');
        };
      }
      row.appendChild(cell);
    }
    grid.appendChild(row);
  });
}

function deleteClassPrompt(id) {
  if (!confirm('Remove this class from timetable?')) return;
  S.classes = S.classes.filter(c => c.id !== id);
  save(); renderTimetable(); showToast('Class removed');
}

function saveClass() {
  const title = document.getElementById('cls-title').value.trim();
  if (!title) { showToast('Enter a title'); return; }
  const cls = {
    id: Date.now().toString(),
    title,
    day: document.getElementById('cls-day').value,
    start: document.getElementById('cls-start').value,
    end: document.getElementById('cls-end').value,
    subject: document.getElementById('cls-subject').value
  };
  S.classes.push(cls);
  save(); closeSheets(); renderTimetable();
  document.getElementById('cls-title').value = '';
  showToast('✓ Added to timetable');
}

function clearWeekPrompt() {
  if (!confirm('Clear all timetable classes?')) return;
  S.classes = []; save(); renderTimetable(); showToast('Timetable cleared');
}

// ═══════════════════════════════════════════════════════
// ROTATIONS PAGE
// ═══════════════════════════════════════════════════════
const DEPT_SUBJECT = {
  'Medicine': 'med', 'Surgery': 'surg', 'Paediatrics': 'paed',
  'Obs & Gynae': 'og', 'Community Medicine': 'cm', 'Forensic Medicine': 'fm'
};

// Pre-built from the PDF for Group A (common reference)
const DEFAULT_ROTATIONS = [
  { id: 'r1', dept: 'Medicine', start: '2026-01-11', end: '2026-02-04', group: 'Group A (CBL)', notes: 'Medicine CBL in Hospital Wards/OPDs' },
  { id: 'r2', dept: 'Surgery', start: '2026-02-05', end: '2026-02-28', group: 'Group A (CBL)', notes: 'Surgery posting' },
  { id: 'r3', dept: 'Paediatrics', start: '2026-03-29', end: '2026-04-22', group: 'Group A (CBL)', notes: 'Paediatrics posting' },
  { id: 'r4', dept: 'Obs & Gynae', start: '2026-04-23', end: '2026-05-18', group: 'Group A (CBL)', notes: 'OG posting' },
];

function renderRotations() {
  renderSemesterProgress();
  renderExamCountdown();
  renderRotationList();
  renderResearchPill();
}

function renderSemesterProgress() {
  const start = new Date('2026-01-11');
  const end = new Date('2026-06-02');
  const now = new Date();
  const total = end - start;
  const elapsed = Math.min(now - start, total);
  const pct = Math.max(0, Math.min(100, (elapsed / total) * 100));
  document.getElementById('sem-progress-bar').style.width = pct.toFixed(1) + '%';
  document.getElementById('sem-progress-pct').textContent = pct.toFixed(0) + '%';
  const daysLeft = Math.max(0, Math.ceil((end - now) / 86400000));
  document.getElementById('days-remaining').textContent = daysLeft;
}

function renderResearchPill() {
  const start = new Date('2026-03-01');
  const end = new Date('2026-03-28');
  const now = new Date();
  const pill = document.getElementById('research-pill');
  if (now < start) { pill.textContent = 'Upcoming'; pill.style.background = 'var(--fill2)'; pill.style.color = 'var(--text3)'; }
  else if (now <= end) { pill.textContent = 'Active'; pill.style.background = 'rgba(48,209,88,.15)'; pill.style.color = 'var(--paed)'; }
  else { pill.textContent = 'Done'; pill.style.background = 'rgba(48,209,88,.1)'; pill.style.color = 'var(--paed)'; }
}

function renderRotationList() {
  const list = document.getElementById('rotation-list');
  const rotations = S.rotations.length > 0 ? S.rotations : DEFAULT_ROTATIONS;
  if (rotations.length === 0) {
    list.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><p>No rotations yet. Tap + to add.</p></div>`;
    return;
  }
  list.innerHTML = '';
  const now = new Date();
  rotations.forEach(rot => {
    const start = new Date(rot.start);
    const end = new Date(rot.end);
    const sk = DEPT_SUBJECT[rot.dept] || 'other';
    const color = subColor(sk);
    let status = 'upcoming', statusTxt = 'Upcoming';
    if (now >= start && now <= end) { status = 'active'; statusTxt = 'Active'; }
    else if (now > end) { status = 'done'; statusTxt = 'Done'; }
    const total = end - start;
    const elapsed = Math.min(now - start, total);
    const pct = status === 'done' ? 100 : status === 'active' ? Math.max(0,(elapsed/total)*100) : 0;
    const startFmt = start.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const endFmt = end.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const card = document.createElement('div');
    card.className = 'rotation-card';
    card.innerHTML = `
      <div class="rc-header">
        <div class="rc-dept">${rot.dept}</div>
        <div class="rc-badge" style="background:${color}22;color:${color}">${statusTxt}</div>
      </div>
      <div class="rc-dates">${startFmt} – ${endFmt} · ${rot.group}</div>
      <div class="rc-progress"><div class="rc-prog-fill" style="width:${pct.toFixed(1)}%;background:${color}"></div></div>
      <div class="rc-stats">
        <div class="rc-stat"><div class="rc-stat-val">${pct.toFixed(0)}%</div><div class="rc-stat-lbl">Progress</div></div>
        <div class="rc-stat"><div class="rc-stat-val">${Math.ceil((end-start)/86400000)}</div><div class="rc-stat-lbl">Total Days</div></div>
        ${rot.notes ? `<div class="rc-stat" style="flex:1"><div class="rc-stat-val" style="font-size:11px;font-weight:600;color:var(--text3)">${rot.notes}</div><div class="rc-stat-lbl">Notes</div></div>` : ''}
      </div>`;
    card.onclick = () => {
      if (confirm('Remove this rotation?')) {
        if (S.rotations.length > 0) {
          S.rotations = S.rotations.filter(r => r.id !== rot.id);
          save(); renderRotations();
        } else showToast('Default rotations cannot be deleted');
      }
    };
    list.appendChild(card);
  });
}

function saveRotation() {
  const dept = document.getElementById('rot-dept').value;
  const start = document.getElementById('rot-start').value;
  const end = document.getElementById('rot-end').value;
  if (!start || !end) { showToast('Please select dates'); return; }
  const rot = {
    id: Date.now().toString(),
    dept, start, end,
    group: document.getElementById('rot-group').value.trim() || 'Group',
    notes: document.getElementById('rot-notes').value.trim()
  };
  // On first custom rotation, clear defaults
  if (S.rotations.length === 0) S.rotations = [];
  S.rotations.push(rot);
  save(); closeSheets(); renderRotations();
  showToast('✓ Rotation saved');
}

// ═══════════════════════════════════════════════════════
// FOCUS / POMODORO
// ═══════════════════════════════════════════════════════
let focusTimer = null;
let focusRunning = false;
let focusPhase = 'work'; // 'work' | 'break'
let focusSecondsLeft = 25 * 60;
let focusWorkMins = 25;
let focusBreakMins = 5;
let focusSessionCount = 0;
let focusCurrentSubject = 'med';
let focusSessionStart = null;
const CIRCUMFERENCE = 2 * Math.PI * 110; // 691.15

function renderFocusPage() {
  renderSubjectChips();
  renderStreakDots();
  renderFocusLogPreview();
  updateOrbDisplay();
}

function renderSubjectChips() {
  const container = document.getElementById('subject-chips');
  container.innerHTML = '';
  Object.entries(SUBJECTS).forEach(([k, sub]) => {
    if (k === 'other') return;
    const chip = document.createElement('button');
    chip.className = 'subj-chip' + (k === focusCurrentSubject ? ' selected' : '');
    chip.textContent = sub.name;
    chip.style.setProperty('--c', sub.color);
    if (k === focusCurrentSubject) chip.style.background = sub.color;
    chip.onclick = () => { focusCurrentSubject = k; renderSubjectChips(); };
    container.appendChild(chip);
  });
}

function selectMode(el, work, brk) {
  document.querySelectorAll('.fc-config-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  focusWorkMins = work; focusBreakMins = brk;
  if (!focusRunning) { focusSecondsLeft = work * 60; focusPhase = 'work'; updateOrbDisplay(); }
  S.pomodoro = { work, break: brk }; save();
}

function toggleFocus() {
  if (focusRunning) { pauseFocus(); return; }
  startFocus();
}

function startFocus() {
  if (!focusRunning) focusSessionStart = Date.now();
  focusRunning = true;
  document.getElementById('fc-main').innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> Pause';
  document.getElementById('fc-stop').style.display = 'flex';
  document.getElementById('fc-skip').style.display = 'flex';
  document.getElementById('orb-wrapper').closest('.focus-orb-container').classList.add('focus-active');
  document.getElementById('focus-status-lbl').textContent = focusPhase === 'work' ? 'Focusing…' : 'Taking a break…';

  focusTimer = setInterval(() => {
    focusSecondsLeft--;
    if (focusSecondsLeft <= 0) { phaseComplete(); return; }
    updateOrbDisplay();
  }, 1000);
}

function pauseFocus() {
  focusRunning = false;
  clearInterval(focusTimer);
  document.getElementById('fc-main').innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg> Resume';
  document.getElementById('focus-status-lbl').textContent = 'Paused';
}

function stopFocus() {
  clearInterval(focusTimer);
  focusRunning = false;
  logFocusSession();
  focusPhase = 'work';
  focusSecondsLeft = focusWorkMins * 60;
  focusSessionCount = 0;
  document.getElementById('fc-main').innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start Session';
  document.getElementById('fc-stop').style.display = 'none';
  document.getElementById('fc-skip').style.display = 'none';
  document.getElementById('focus-status-lbl').textContent = 'Ready to begin';
  document.getElementById('orb-wrapper').closest('.focus-orb-container').classList.remove('focus-active');
  updateOrbDisplay(); renderFocusLogPreview(); renderStreakDots();
}

function skipPhase() { phaseComplete(); }

function phaseComplete() {
  clearInterval(focusTimer);
  focusRunning = false;
  if (focusPhase === 'work') {
    logFocusSession();
    focusSessionCount++;
    focusPhase = 'break';
    focusSecondsLeft = focusBreakMins * 60;
    document.getElementById('focus-status-lbl').textContent = 'Break time! 🌿';
    document.getElementById('orb-glow').classList.add('break');
    document.getElementById('orb-ring').style.stroke = 'var(--green)';
    vibrate();
  } else {
    focusPhase = 'work';
    focusSecondsLeft = focusWorkMins * 60;
    document.getElementById('orb-glow').classList.remove('break');
    document.getElementById('orb-ring').style.stroke = 'var(--accent)';
    document.getElementById('focus-status-lbl').textContent = 'Ready for next session';
    vibrate();
  }
  updateOrbDisplay();
  renderStreakDots();
  document.getElementById('fc-main').innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>' + (focusPhase === 'work' ? ' Next Session' : ' Start Break');
  // Auto-start break
  setTimeout(() => { if (!focusRunning) startFocus(); }, 800);
}

function logFocusSession() {
  if (!focusSessionStart) return;
  const elapsed = Math.round((Date.now() - focusSessionStart) / 60000);
  if (elapsed < 1) return;
  S.focusLog.unshift({ id: Date.now().toString(), date: todayStr(), subject: focusCurrentSubject, duration: elapsed, phase: 'work', time: new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}) });
  S.focusLog = S.focusLog.slice(0, 100);
  save(); renderFocusLogPreview();
  focusSessionStart = null;
}

function updateOrbDisplay() {
  const total = focusPhase === 'work' ? focusWorkMins * 60 : focusBreakMins * 60;
  const pct = focusSecondsLeft / total;
  const offset = CIRCUMFERENCE * (1 - pct);
  document.getElementById('orb-ring').style.strokeDashoffset = offset;
  const m = Math.floor(focusSecondsLeft / 60), s = focusSecondsLeft % 60;
  document.getElementById('orb-time').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  document.getElementById('orb-phase').textContent = focusRunning ? (focusPhase === 'work' ? 'Focus' : 'Break') : (focusPhase === 'work' ? 'Tap to begin' : 'Break');
}

function renderStreakDots() {
  const container = document.getElementById('focus-streak');
  container.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const dot = document.createElement('div');
    dot.className = 'streak-dot' + (i < focusSessionCount ? ' done' : '');
    container.appendChild(dot);
    if (i < 3) { const br = document.createElement('div'); br.className = 'streak-dot break-dot'; container.appendChild(br); }
  }
}

function renderFocusLogPreview() {
  const container = document.getElementById('focus-log-preview');
  const todayLog = S.focusLog.filter(l => l.date === todayStr()).slice(0, 5);
  if (todayLog.length === 0) { container.innerHTML = `<div style="text-align:center;padding:16px;color:var(--text3);font-size:14px">No sessions yet today</div>`; return; }
  container.innerHTML = todayLog.map(l => `
    <div class="fl-row">
      <div class="fl-dot" style="background:${subColor(l.subject)}"></div>
      <div class="fl-subject">${subName(l.subject)}</div>
      <div class="fl-time">${l.time || ''}</div>
      <div class="fl-dur">${l.duration}m</div>
    </div>`).join('');
}

function renderFullFocusLog() {
  const container = document.getElementById('focus-log-full');
  if (S.focusLog.length === 0) { container.innerHTML = `<div style="text-align:center;padding:32px;color:var(--text3);font-size:15px">No focus sessions recorded yet</div>`; return; }
  // Group by date
  const byDate = {};
  S.focusLog.forEach(l => { if (!byDate[l.date]) byDate[l.date] = []; byDate[l.date].push(l); });
  container.innerHTML = Object.keys(byDate).map(date => {
    const d = new Date(date + 'T12:00:00');
    const total = byDate[date].reduce((a,l) => a+l.duration,0);
    const items = byDate[date].map(l => `<div class="fl-row"><div class="fl-dot" style="background:${subColor(l.subject)}"></div><div class="fl-subject">${subName(l.subject)}</div><div class="fl-time">${l.time||''}</div><div class="fl-dur">${l.duration}m</div></div>`).join('');
    return `<div style="margin-bottom:16px"><div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px;display:flex;justify-content:space-between">${d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}<span>${total}m total</span></div>${items}</div>`;
  }).join('');
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
}

// ═══════════════════════════════════════════════════════
// EXPORT / CLEAR
// ═══════════════════════════════════════════════════════
function exportData() {
  const blob = new Blob([JSON.stringify(S, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'plnx-backup.json'; a.click();
  URL.revokeObjectURL(url); showToast('Exported!');
}

function clearAllData() {
  if (!confirm('Clear all PlnX data? This cannot be undone.')) return;
  localStorage.removeItem(KEY);
  S = { theme: S.theme, events: {}, classes: [], rotations: [], focusLog: [], pomodoro: {work:25,break:5} };
  save(); renderToday(); showToast('All data cleared');
}

// ═══════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════
renderToday();
renderSubjectChips();
renderStreakDots();
updateOrbDisplay();

// Exam countdown clock
setInterval(renderExamCountdown, 60000);

// Service Worker (PWA)
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('data:application/javascript,self.addEventListener("fetch",e=>e.respondWith(fetch(e.request)))').catch(()=>{});
}
</script>
</body>
</html>
